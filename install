#!/bin/bash
# Install script to set up a general unix / linux capable computer as a
# development machine

echo "Beginning installation of dotfiles..."

# Set Operating System Variables
if [ "$(uname)" == "Darwin" ]; then
    export DARWIN=1
elif [ "$(uname)" == "Linux" ]; then
    export LINUX=1
fi

# Get the location of the dotfiles
pushd "$(dirname "$0")" > /dev/null
DOTFILES="$(pwd -P)"
popd > /dev/null

# Create a file at ~/.dotfiles if no file is present there and not installed there
if [ "$DOTFILES" != "$HOME/.dotfiles" ]; then
    # test if a file or symlink is present at ~/.dotfiles
    if [ -e "$HOME/.dotfiles" ] || [ -h "$HOME/.dotfiles" ]; then
        # exit the program as this cannot be sucessfully installed then
        echo -e "A file or directory is present at $HOME/.dotfiles... Aborting."
        exit 1
    fi
    # put the location of dotfiles at ~/.dotfiles in a file
    echo "$DOTFILES" > "$HOME/.dotfiles"
fi

# Set XDG_CONFIG_HOME if unset
[ -n "$XDG_CONFIG_HOME" ] || export XDG_CONFIG_HOME="$HOME/.config"

if [ -n "$DARWIN" ]; then
    # Install homebrew and brew everything in Brewfile

    echo -e "\nInstalling xcode commandline tools..."
    xcode-select --install >/dev/null 2>&1


    # Install homebrew if nescessary
    brew help >/dev/null 2>&1 || \
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

    echo -e "\nBrewing formulas..."

    # Use brew-bundle to install brewfiles in a good order
    brew tap Homebrew/bundle 2>/dev/null
    brew bundle --file="~/.dotfiles/Brewfile"
fi

# Links all of the files with the extension .sym* to the home directory.
echo -e "\nCreating symlinks..."

# Takes a pattern (e.g. ".symdot" and a function that transforms the basename
# of the file to its destination then links all files ending in the pattern to
# the correct location
function linkfiles () {
    local pattern="$1"
    local mapper="$2"
    tolink=$(find -H "$DOTFILES" -maxdepth 5 -name "*$pattern")
    for file in $tolink; do
        local target
        target="$("$mapper" "$(basename "$file" "$pattern")")"
        if [ -e "$target" ] || [ -h "$target" ]; then
            echo "$target exists... Skipping."
        else
            echo "Creating symlink for $file"
            ln -s "$file" "$target"
        fi
    done
}

function symdot_mapper { echo "$HOME/.$1"; }
# Symlink files to be symlinked to every platform
linkfiles ".symdot" "symdot_mapper"
# Symlink OS X specific files
[ -n "$DARWIN" ] && linkfiles ".symdot.osx" "symdot_mapper"

# Make sure XDG_CONFIG_HOME exists
mkdir -p "$HOME/.config"
function config_mapper { echo "$HOME/.config/$1"; }
# symlink files that should go in xdg_config_home
linkfiles ".symconfig" "config_mapper"

# Setup fzf
if [ ! -d "$HOME/.fzf" ]; then
    echo -e "\nInstalling fzf..."
    git clone https://github.com/junegunn/fzf.git --depth 1 "$HOME/.fzf" >/dev/null &&\
    echo -e "y\ny\nn" | "$HOME/.fzf/install" ||\
    echo "Failed to install fzf!"
fi
